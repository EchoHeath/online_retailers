# online_retailers 分布式微服务电商系统
目录介绍
  api客户端
  srv服务端
  postman模拟请求,具体接口可看proto文件

技术要点
  注册中心  consul
  配置中心  nacos
  链路追踪  jaeger
  限流熔断  sentinel
  并发抢购  分布式锁
  消息处理  rocketmq消息回查
  
抢购商品的思路
  举例：例如12306抢购车票
  执行步骤：客户端发起订单创建请求->服务端发起库存扣减服务->服务端发起订单生成服务(->服务端发起增加积分服务)->返回结果
  微服务架构：客户端服务、订单服务、库存服务、(积分服务)，每个微服务>1台服务器，通过consul注册，其他服务调用通过最小连接数算法连接，配置都是在nacos动态读取的
  思路：
    1.服务端接收到订单请求，开启本地mysql事物，向rocketmq发起half事物请求
    2.向库存服务发起grpc调用
    3.扣减成功则执行本地事物，结束后commit rocketmq事物
    4.如发生网络抖动、网络拥塞或硬件故障导致超时，rocketmq无法接收消息则发起回源信息回查订单状态，
    根据订单状态rollback或commit扣减库存服务，扣减失败则全部回滚事物。
    5.订单结束后向rocketmq另一个队列发送一个半小时延时消息，收到消息后如未支付订单则恢复库存并取消订单
    6.库存服务需要使用redis分布式锁处理并发请求(代码中有import的库)，分析源码：获取redis连接池，并向所有的集群同时发送setnx命令，
    当接收到n/2+1个成功命令(发送一台则会有等待集群同步key的时间，并发情况下集群内会造成锁冲突),可判断为申请分布式锁成功，解锁也是如此，
    每个key只能由申请锁的人删除(申请时key的随机value匹配)，需要向集群全部发送一个lua命令(原子性操作，判断key是否存在并匹配value)进行删除key处理
    7.每个接口可以在gin框架中配置中间件用来失败重试
